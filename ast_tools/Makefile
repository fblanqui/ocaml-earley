OCAMLVERSION=$(shell ocamlc -version)
DECAP=..
PA_OCAML=$(DECAP)/pa_ocaml

ifeq ($(OCAMLVERSION),3.12.1)
COMPILER_INC = -I +compiler-libs/parsing -I +compiler-libs/typing -I +compiler-libs/utils
COMPILER_LIBS = misc.cmo config.cmo longident.cmo printast.cmo linenum.cmo warnings.cmo location.cmo
COMPILER_PARSERS = syntaxerr.cmo lexer.cmo clflags.cmo parser.cmo parse.cmo
COMPILER_TOP = toplevellib.cma
else
COMPILER_INC = -I +compiler-libs
COMPILER_LIBS = ocamlcommon.cma
COMPILER_PARSERS =
COMPILER_TOP = ocamlbytecomp.cma ocamltoplevel.cma
endif

COMPILER_LIBO := $(COMPILER_LIBS:.cma=.cmxa)
COMPILER_LIBO := $(COMPILER_LIBO:.cmo=.cmx)
COMPILER_PARSERO := $(COMPILER_PARSERS:.cma=.cmxa)
COMPILER_PARSERO := $(COMPILER_PARSERO:.cmo=.cmx)

all: pa_eq pa_quote compare.cmx iter.cmx quote.cmx

pa_eq: pa_eq.ml $(DECAP)/decap.cmxa $(DECAP)/decap_ocaml.cmxa
	ocamlopt -pp $(PA_OCAML) -I $(DECAP) $(COMPILER_INC) $(COMPILER_LIBO) -o $@ unix.cmxa str.cmxa decap.cmxa decap_ocaml.cmxa $<

pa_iter: pa_iter.ml $(DECAP)/decap.cmxa $(DECAP)/decap_ocaml.cmxa
	ocamlopt -pp $(PA_OCAML) -I $(DECAP) $(COMPILER_INC) $(COMPILER_LIBO) -o $@ unix.cmxa str.cmxa decap.cmxa decap_ocaml.cmxa $<

pa_quote: pa_quote.ml $(DECAP)/decap.cmxa $(DECAP)/decap_ocaml.cmxa
	ocamlopt -pp $(PA_OCAML) -I $(DECAP) $(COMPILER_INC) $(COMPILER_LIBO) -o $@ unix.cmxa str.cmxa decap.cmxa decap_ocaml.cmxa $<

asttypes.mli:
	cp ast-$(OCAMLVERSION)/asttypes.mli .

parsetree.mli:
	cp ast-$(OCAMLVERSION)/parsetree.mli .

# FIXME target construction does not fail if pa_eq fails...
compare.ml: pa_eq generic_eq.ml parsetree.mli asttypes.mli
	cat generic_eq.ml > $@
	@echo "(* asttypes.mli *)" >> $@
	./pa_eq asttypes.mli >> $@
	@echo "" >> $@
	@echo "(* parsetree.mli *)" >> $@
	./pa_eq parsetree.mli >> $@

# FIXME target construction does not fail if pa_eq fails...
iter.ml: pa_iter generic_iter.ml parsetree.mli asttypes.mli
	cat generic_iter.ml > $@
	@echo "(* asttypes.mli *)" >> $@
	./pa_iter asttypes.mli >> $@
	@echo "" >> $@
	@echo "(* parsetree.mli *)" >> $@
	./pa_iter parsetree.mli >> $@

# FIXME target construction does not fail if pa_quote fails...
quote.ml: pa_quote generic_quote.ml parsetree.mli asttypes.mli
	cat generic_quote.ml > $@
	@echo "(* asttypes.mli *)" >> $@
	./pa_quote asttypes.mli >> $@
	@echo "" >> $@
	@echo "(* parsetree.mli *)" >> $@
	./pa_quote parsetree.mli >> $@

compare.cmx: compare.ml
	ocamlopt -c $(COMPILER_INC) $(COMPILER_LIBO) $<

compare.cmo: compare.ml
	ocamlopt -c $(COMPILER_INC) $(COMPILER_LIBO) $<

iter.cmx: iter.ml
	ocamlopt -c $(COMPILER_INC) $(COMPILER_LIBO) $<

iter.cmo: iter.ml
	ocamlopt -c $(COMPILER_INC) $(COMPILER_LIBO) $<

quote.cmx: quote.ml
	ocamlopt -c -I $(DECAP) $(COMPILER_INC) $(COMPILER_LIBO) $<

quote.cmo: quote.ml
	ocamlopt -c -I $(DECAP) $(COMPILER_INC) $(COMPILER_LIBO) $<

clean:
	rm -f *.cmi *.cmx *.cmo *.cma *.cmxa *.o

distclean: clean
	rm -f pa_eq pa_quote compare.ml iter.ml quote.ml asttypes.mli parsetree.mli
